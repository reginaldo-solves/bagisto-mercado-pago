openapi: 3.0.3
info:
  title: Mercado Pago Payment API
  description: API interna para processamento de pagamentos Mercado Pago no Bagisto (Docker Environment)
  version: 1.0.0
  contact:
    name: Bagisto Development Team

paths:
  /api/mercado-pago/webhook:
    post:
      summary: Receber webhooks do Mercado Pago
      description: Endpoint para receber eventos de webhook do Mercado Pago para confirmação de pagamentos
      tags:
        - Webhooks
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookPayload'
            examples:
              payment_created:
                summary: Webhook de pagamento criado
                value:
                  id: "123456789"
                  action: "payment.created"
                  api_version: "v1"
                  data:
                    id: "payment123"
                  date_created: "2025-01-03T10:00:00Z"
                  type: "payment"
              payment_updated:
                summary: Webhook de pagamento atualizado
                value:
                  id: "987654321"
                  action: "payment.updated"
                  api_version: "v1"
                  data:
                    id: "payment456"
                  date_created: "2025-01-03T10:30:00Z"
                  type: "payment"
      responses:
        '200':
          description: Webhook recebido e enfileirado para processamento
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
              example:
                status: "received"
                message: "Webhook enfileirado para processamento"
        '400':
          description: Requisição inválida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/mercado-pago/payment/pix:
    post:
      summary: Criar pagamento Pix
      description: Inicia um pagamento via Pix usando API do Mercado Pago
      tags:
        - Payments
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePixPaymentRequest'
            example:
              order_id: 123
              amount: 150.75
              customer_email: "cliente@exemplo.com"
              customer_document: "12345678901"
      responses:
        '201':
          description: Pagamento Pix criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePixPaymentResponse'
              example:
                transaction_id: "trans_123"
                mercado_pago_id: "payment123"
                qr_code: "00020126580014br.gov.bcb.pix0134123456789012345678901234567890123456789012345204000053039865404150.755802BR5913NOME EMPRESA6009SAO PAULO62140510FILIAL1236304AABB"
                qr_code_url: "https://mp.com/qr/123456"
                expiration_time: "2025-01-03T11:00:00Z"
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '402':
          description: Pagamento não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/mercado-pago/payment/credit-card:
    post:
      summary: Criar pagamento com Cartão de Crédito
      description: Processa pagamento com cartão de crédito via checkout transparente Mercado Pago
      tags:
        - Payments
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCreditCardPaymentRequest'
            example:
              order_id: 124
              amount: 299.90
              customer_email: "cliente@exemplo.com"
              customer_document: "12345678901"
              token: "card_token_123"
              installments: 3
      responses:
        '201':
          description: Pagamento com cartão processado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateCreditCardPaymentResponse'
              example:
                transaction_id: "trans_124"
                mercado_pago_id: "payment124"
                status: "approved"
                installments: 3
                first_payment: 99.97
                total_paid: 299.90
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '402':
          description: Pagamento recusado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/mercado-pago/payment/boleto:
    post:
      summary: Criar pagamento Boleto
      description: Gera boleto bancário via API do Mercado Pago
      tags:
        - Payments
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBoletoPaymentRequest'
            example:
              order_id: 125
              amount: 500.00
              customer_email: "cliente@exemplo.com"
              customer_document: "12345678901"
              first_due_date: "2025-01-10"
      responses:
        '201':
          description: Boleto gerado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateBoletoPaymentResponse'
              example:
                transaction_id: "trans_125"
                mercado_pago_id: "payment125"
                boleto_url: "https://mp.com/boleto/123456"
                barcode: "12345678901234567890123456789012345678901234"
                expiration_date: "2025-01-10"
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/mercado-pago/payment/{transaction_id}:
    get:
      summary: Consultar status de transação
      description: Retorna informações detalhadas sobre uma transação específica
      tags:
        - Payments
      security:
        - BearerAuth: []
      parameters:
        - name: transaction_id
          in: path
          required: true
          schema:
            type: string
          description: ID da transação interna
      responses:
        '200':
          description: Detalhes da transação
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionDetails'
              example:
                transaction_id: "trans_123"
                mercado_pago_id: "payment123"
                payment_method: "pix"
                amount: 150.75
                currency: "BRL"
                status: "approved"
                created_at: "2025-01-03T10:00:00Z"
                confirmed_at: "2025-01-03T10:15:00Z"
                qr_code: "00020126580014br.gov.bcb.pix..."
        '404':
          description: Transação não encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    WebhookPayload:
      type: object
      required:
        - id
        - action
        - api_version
        - data
        - date_created
        - type
      properties:
        id:
          type: string
          description: ID único do webhook
        action:
          type: string
          enum: ["payment.created", "payment.updated"]
          description: Tipo de ação do webhook
        api_version:
          type: string
          description: Versão da API
        data:
          type: object
          properties:
            id:
              type: string
              description: ID do pagamento no Mercado Pago
        date_created:
          type: string
          format: date-time
          description: Data de criação do webhook
        type:
          type: string
          enum: ["payment"]
          description: Tipo do recurso

    WebhookResponse:
      type: object
      properties:
        status:
          type: string
          enum: ["received"]
          description: Status do processamento
        message:
          type: string
          description: Mensagem de status

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              description: Código do erro
            message:
              type: string
              description: Mensagem de erro
            details:
              type: object
              description: Detalhes adicionais do erro

    CreatePixPaymentRequest:
      type: object
      required:
        - order_id
        - amount
        - customer_email
        - customer_document
      properties:
        order_id:
          type: integer
          description: ID do pedido
        amount:
          type: number
          format: decimal
          minimum: 0.01
          description: Valor do pagamento
        customer_email:
          type: string
          format: email
          description: Email do cliente
        customer_document:
          type: string
          pattern: '^[0-9]{11,14}$'
          description: CPF ou CNPJ do cliente

    CreatePixPaymentResponse:
      type: object
      required:
        - transaction_id
        - mercado_pago_id
        - qr_code
        - qr_code_url
        - expiration_time
      properties:
        transaction_id:
          type: string
          description: ID da transação interna
        mercado_pago_id:
          type: string
          description: ID do pagamento no Mercado Pago
        qr_code:
          type: string
          description: QR Code para pagamento Pix
        qr_code_url:
          type: string
          format: uri
          description: URL do QR Code
        expiration_time:
          type: string
          format: date-time
          description: Tempo de expiração do QR Code

    CreateCreditCardPaymentRequest:
      type: object
      required:
        - order_id
        - amount
        - customer_email
        - customer_document
        - token
      properties:
        order_id:
          type: integer
          description: ID do pedido
        amount:
          type: number
          format: decimal
          minimum: 0.01
          description: Valor do pagamento
        customer_email:
          type: string
          format: email
          description: Email do cliente
        customer_document:
          type: string
          pattern: '^[0-9]{11,14}$'
          description: CPF ou CNPJ do cliente
        token:
          type: string
          description: Token do cartão gerado pelo frontend
        installments:
          type: integer
          minimum: 1
          maximum: 12
          description: Número de parcelas

    CreateCreditCardPaymentResponse:
      type: object
      required:
        - transaction_id
        - mercado_pago_id
        - status
      properties:
        transaction_id:
          type: string
          description: ID da transação interna
        mercado_pago_id:
          type: string
          description: ID do pagamento no Mercado Pago
        status:
          type: string
          enum: ["approved", "rejected", "pending"]
          description: Status do pagamento
        installments:
          type: integer
          description: Número de parcelas
        first_payment:
          type: number
          format: decimal
          description: Valor da primeira parcela
        total_paid:
          type: number
          format: decimal
          description: Total pago com juros

    CreateBoletoPaymentRequest:
      type: object
      required:
        - order_id
        - amount
        - customer_email
        - customer_document
      properties:
        order_id:
          type: integer
          description: ID do pedido
        amount:
          type: number
          format: decimal
          minimum: 0.01
          description: Valor do pagamento
        customer_email:
          type: string
          format: email
          description: Email do cliente
        customer_document:
          type: string
          pattern: '^[0-9]{11,14}$'
          description: CPF ou CNPJ do cliente
        first_due_date:
          type: string
          format: date
          description: Data de vencimento do primeiro boleto

    CreateBoletoPaymentResponse:
      type: object
      required:
        - transaction_id
        - mercado_pago_id
        - boleto_url
        - barcode
        - expiration_date
      properties:
        transaction_id:
          type: string
          description: ID da transação interna
        mercado_pago_id:
          type: string
          description: ID do pagamento no Mercado Pago
        boleto_url:
          type: string
          format: uri
          description: URL do boleto para download
        barcode:
          type: string
          length: 44
          description: Código de barras do boleto
        expiration_date:
          type: string
          format: date
          description: Data de vencimento do boleto

    TransactionDetails:
      type: object
      required:
        - transaction_id
        - mercado_pago_id
        - payment_method
        - amount
        - currency
        - status
        - created_at
      properties:
        transaction_id:
          type: string
          description: ID da transação interna
        mercado_pago_id:
          type: string
          description: ID do pagamento no Mercado Pago
        payment_method:
          type: string
          enum: ["pix", "credit_card", "boleto"]
          description: Método de pagamento
        amount:
          type: number
          format: decimal
          description: Valor da transação
        currency:
          type: string
          length: 3
          description: Moeda (BRL)
        status:
          type: string
          enum: ["pending", "approved", "rejected", "cancelled"]
          description: Status da transação
        created_at:
          type: string
          format: date-time
          description: Data de criação
        confirmed_at:
          type: string
          format: date-time
          description: Data de confirmação
        qr_code:
          type: string
          description: QR Code (apenas para Pix)
        boleto_url:
          type: string
          description: URL do boleto (apenas para Boleto)
        barcode:
          type: string
          description: Código de barras (apenas para Boleto)
        expiration_date:
          type: string
          format: date
          description: Data de expiração (apenas para Pix/Boleto)
        installments:
          type: integer
          description: Parcelas (apenas para Cartão)

tags:
  - name: Webhooks
    description: Endpoints para processamento de webhooks do Mercado Pago
  - name: Payments
    description: Endpoints para criação e consulta de pagamentos
